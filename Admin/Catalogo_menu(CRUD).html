<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catálogo de Servicios (CRUD)</title>
  <link rel="stylesheet" href="../Css/Catalogo_Menu.css">
  <style>
    .container { max-width: 1100px; margin: 24px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .grid { display: grid; grid-template-columns: 140px 1fr 160px 1fr 140px 140px; gap: 10px; }
    .grid input { padding: 10px; border: 1px solid #e5e7eb; border-radius: 10px; }
    .btn { padding: 10px 14px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; background:#4f46e5; color:#fff; }
    .btn-secondary { background:#0ea5e9; }
    .btn-danger { background:#ef4444; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
    .status { margin-top: 8px; font-size: 14px; }
  </style>
</head>
<body>
  <header style="background:#111827; color:#fff; padding:12px 16px;">
    <nav style="display:flex; gap:16px; align-items:center;">
      <strong>Energym Admin</strong>
      <a href="../Admin/CatalogoAtleta.php" style="color:#fff; text-decoration:none;">Atletas</a>
      <a href="../Admin/Catalogo_menu(CRUD).html" style="color:#fff; text-decoration:none;">Servicios</a>
      <a href="../Admin/ReservacionesAdmin.php" style="color:#fff; text-decoration:none;">Reservaciones</a>
      <span style="flex:1"></span>
      <a href="../Php/logoutAdmin.php" style="color:#fca5a5; text-decoration:none;">Cerrar sesión</a>
    </nav>
  </header>
  <div class="container">
    <h2>Catálogo de Servicios</h2>

    <div class="grid">
      <input id="codigo" placeholder="Código (único)" />
      <input id="nombre" placeholder="Nombre del servicio" />
      <input id="tipo" placeholder="Tipo de zona" />
      <input id="instructor" placeholder="Instructor" />
      <input id="costo" type="number" step="0.01" min="0" placeholder="Costo" />
      <button id="guardar" class="btn">Guardar</button>
    </div>
    <div id="mensaje" class="status"></div>

    <table>
      <thead>
        <tr><th>Código</th><th>Nombre</th><th>Tipo</th><th>Instructor</th><th>Costo</th><th>Acciones</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const mensaje = document.getElementById('mensaje');

    function showMessage(text, ok = true){
      mensaje.textContent = text;
      mensaje.style.color = ok ? '#16a34a' : '#ef4444';
      setTimeout(() => mensaje.textContent = '', 3000);
    }

    function tryParseJson(text){
      if (typeof text !== 'string') return null;
      let t = text.replace(/^\uFEFF/, '').trim();
      try { return JSON.parse(t); } catch {}
      const startBraces = ['{','['].map(ch => t.indexOf(ch)).filter(i => i >= 0);
      const start = startBraces.length ? Math.min(...startBraces) : -1;
      const endObj = t.lastIndexOf('}');
      const endArr = t.lastIndexOf(']');
      const end = Math.max(endObj, endArr);
      if (start >= 0 && end >= start) {
        t = t.substring(start, end + 1);
        try { return JSON.parse(t); } catch {}
      }
      return null;
    }

    function fillForm(s){
      document.getElementById('codigo').value = s.codigo;
      document.getElementById('nombre').value = s.nombre || '';
      document.getElementById('tipo').value = s.tipo || '';
      document.getElementById('instructor').value = s.instructor || '';
      document.getElementById('costo').value = s.costo || '';
    }

    async function loadServicios(){
      tbody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
      try {
        const res = await fetch('../Php/admin_servicios_listar.php', { credentials: 'include' });
        const txt = await res.text();
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan=\"6\">Error al cargar (${res.status}). ${txt.substring(0,200)}</td></tr>`;
          return;
        }
        const trimmed = (txt || '').trim();
        const data = trimmed.length === 0 ? [] : tryParseJson(txt);
        if (!data) {
          tbody.innerHTML = '<tr><td colspan="6">Error al cargar (formato no válido)</td></tr>';
          console.error('Respuesta no JSON', txt);
          return;
        }
        render(data);
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6">Error al cargar (formato no válido)</td></tr>';
      }
    }

    function render(data){
      tbody.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0){
        tbody.innerHTML = '<tr><td colspan="6">Sin registros</td></tr>';
        return;
      }
      data.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.codigo}</td>
          <td>${s.nombre ?? ''}</td>
          <td>${s.tipo ?? ''}</td>
          <td>${s.instructor ?? ''}</td>
          <td>${s.costo ?? ''}</td>
          <td>
            <button class="btn btn-secondary" data-edit="${s.codigo}">Editar</button>
            <button class="btn btn-danger" data-del="${s.codigo}">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-edit]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const codigo = btn.getAttribute('data-edit');
          const row = Array.from(tbody.children).find(tr => tr.firstElementChild.textContent === codigo);
          if (row){
            fillForm({
              codigo,
              nombre: row.children[1].textContent,
              tipo: row.children[2].textContent,
              instructor: row.children[3].textContent,
              costo: row.children[4].textContent
            });
          }
        });
      });

      tbody.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const codigo = btn.getAttribute('data-del');
          if (!confirm('¿Eliminar servicio ' + codigo + '?')) return;
          const form = new FormData();
          form.append('codigo', codigo);
          const res = await fetch('../Php/admin_servicios_eliminar.php', { method: 'POST', credentials: 'include', body: form });
          const txt = await res.text();
          const json = tryParseJson(txt) || {};
          if (res.ok){
            showMessage(json.mensaje || 'Eliminado');
            loadServicios();
          } else {
            showMessage((json.error || `Error al eliminar (${res.status}) ${txt.substring(0,120)}`), false);
          }
        });
      });
    }

    document.getElementById('guardar').addEventListener('click', async () => {
      const codigo = document.getElementById('codigo').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const tipo = document.getElementById('tipo').value.trim();
      const instructor = document.getElementById('instructor').value.trim();
      const costo = document.getElementById('costo').value.trim();
      if (!codigo || !nombre){ showMessage('Código y nombre son obligatorios', false); return; }
      const form = new FormData();
      form.append('codigo', codigo);
      form.append('nombre', nombre);
      form.append('tipo', tipo);
      form.append('instructor', instructor);
      form.append('costo', costo);
      const res = await fetch('../Php/admin_servicios_guardar.php', { method: 'POST', credentials: 'include', body: form });
      const txt = await res.text();
      const json = tryParseJson(txt) || {};
      if (res.ok){
        showMessage(json.mensaje || 'Guardado');
        document.querySelectorAll('.grid input').forEach(i => i.value = '');
        loadServicios();
      } else {
        showMessage((json.error || `Error al guardar (${res.status}) ${txt.substring(0,120)}`), false);
      }
    });

    loadServicios();
  </script>
</body>
</html>
